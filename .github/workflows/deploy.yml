# =============================================================================
# CD (Continuous Deployment) Pipeline - Docker
# =============================================================================
# Деплой через Docker Compose на VPS
# =============================================================================

name: Deploy to VPS

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      rebuild_backend:
        description: 'Force rebuild backend image'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20.x'
  APP_DIR: '/var/www/postcard-bot'

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # JOB 1: Сборка Frontend
  # ===========================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Build frontend
        run: npm run build
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_TELEGRAM_BOT_USERNAME: ${{ secrets.VITE_TELEGRAM_BOT_USERNAME }}

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # ===========================================================================
  # JOB 2: Деплой на VPS
  # ===========================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-frontend

    environment:
      name: production
      url: https://poct-card.ru

    steps:
      # -----------------------------------------------------------------------
      # Скачивание артефактов
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      # -----------------------------------------------------------------------
      # Подготовка deploy package
      # -----------------------------------------------------------------------
      - name: Create deployment package
        run: |
          mkdir -p deploy-package

          # Backend (исходники для сборки в Docker)
          cp -r backend deploy-package/

          # Frontend (уже собранный)
          mkdir -p deploy-package/frontend
          cp -r frontend/dist deploy-package/frontend/

          # Deploy конфиги
          cp -r deploy deploy-package/

          # Создаем архив
          tar -czvf deploy-package.tar.gz deploy-package

      # -----------------------------------------------------------------------
      # Настройка SSH
      # -----------------------------------------------------------------------
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # -----------------------------------------------------------------------
      # Копирование на сервер
      # -----------------------------------------------------------------------
      - name: Copy files to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            deploy-package.tar.gz \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/

      # -----------------------------------------------------------------------
      # Выполнение деплоя
      # -----------------------------------------------------------------------
      - name: Execute deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'

          set -e

          echo "=========================================="
          echo "Starting Docker deployment..."
          echo "=========================================="

          APP_DIR="/var/www/postcard-bot"
          BACKUP_DIR="/var/www/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Создаем backup
          echo "Creating backup..."
          mkdir -p $BACKUP_DIR
          if [ -d "$APP_DIR/frontend/dist" ]; then
            tar -czvf $BACKUP_DIR/backup_$TIMESTAMP.tar.gz -C $APP_DIR frontend/dist 2>/dev/null || true
            ls -t $BACKUP_DIR/backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
          fi

          # Распаковываем
          echo "Extracting new version..."
          cd /tmp
          rm -rf deploy-package
          tar -xzvf deploy-package.tar.gz

          # Обновляем backend
          echo "Updating backend..."
          rm -rf $APP_DIR/backend/src $APP_DIR/backend/prisma
          cp -r deploy-package/backend/src $APP_DIR/backend/
          cp -r deploy-package/backend/prisma $APP_DIR/backend/
          cp deploy-package/backend/package.json $APP_DIR/backend/
          cp deploy-package/backend/package-lock.json $APP_DIR/backend/
          cp deploy-package/backend/tsconfig.json $APP_DIR/backend/
          cp deploy-package/backend/Dockerfile $APP_DIR/backend/
          cp deploy-package/backend/.dockerignore $APP_DIR/backend/ 2>/dev/null || true

          # Обновляем frontend
          echo "Updating frontend..."
          rm -rf $APP_DIR/frontend/dist
          cp -r deploy-package/frontend/dist $APP_DIR/frontend/

          # Обновляем deploy конфиги
          echo "Updating deploy configs..."
          cp deploy-package/deploy/docker-compose.yml $APP_DIR/deploy/
          cp deploy-package/deploy/nginx.conf $APP_DIR/deploy/

          # Переходим в директорию deploy
          cd $APP_DIR/deploy

          # Проверяем наличие .env файлов
          if [ ! -f ".env" ]; then
            echo "ERROR: .env file not found!"
            exit 1
          fi
          if [ ! -f "backend.env" ]; then
            echo "ERROR: backend.env file not found!"
            exit 1
          fi

          # Пересобираем backend образ
          echo "Building backend image..."
          docker compose build backend

          # Перезапускаем сервисы
          echo "Restarting services..."
          docker compose up -d --force-recreate nginx
          docker compose up -d

          # Ждем готовности
          echo "Waiting for services..."
          sleep 10

          # Применяем миграции
          echo "Running database migrations..."
          docker exec postcard-backend npx prisma migrate deploy || echo "Migrations already applied"

          # Проверяем статус
          echo "Checking services..."
          docker compose ps

          # Очистка
          echo "Cleaning up..."
          rm -rf /tmp/deploy-package
          rm -f /tmp/deploy-package.tar.gz

          # Очистка старых Docker образов
          docker image prune -f

          echo "=========================================="
          echo "Deployment completed successfully!"
          echo "=========================================="

          DEPLOY_SCRIPT

      # -----------------------------------------------------------------------
      # Health check
      # -----------------------------------------------------------------------
      - name: Health check
        run: |
          sleep 15
          HEALTH_URL="${{ secrets.APP_URL }}/api/health"
          echo "Checking health at: $HEALTH_URL"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Health check passed!"
          else
            echo "Warning: Health check returned status $HTTP_STATUS"
          fi
        continue-on-error: true

      # -----------------------------------------------------------------------
      # Уведомления
      # -----------------------------------------------------------------------
      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment to production completed successfully!"
          echo "Application URL: ${{ secrets.APP_URL }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Deployment failed! Please check the logs."

  # ===========================================================================
  # JOB 3: Rollback (ручной)
  # ===========================================================================
  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    needs: deploy

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Execute rollback
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ROLLBACK_SCRIPT'

          set -e
          echo "Starting rollback..."

          APP_DIR="/var/www/postcard-bot"
          BACKUP_DIR="/var/www/backups"

          LATEST_BACKUP=$(ls -t $BACKUP_DIR/backup_*.tar.gz 2>/dev/null | head -1)

          if [ -z "$LATEST_BACKUP" ]; then
            echo "No backup found! Cannot rollback."
            exit 1
          fi

          echo "Rolling back to: $LATEST_BACKUP"

          cd $APP_DIR
          tar -xzvf $LATEST_BACKUP

          cd $APP_DIR/deploy
          docker compose up -d --force-recreate

          echo "Rollback completed!"

          ROLLBACK_SCRIPT
