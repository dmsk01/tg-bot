# =============================================================================
# CD (Continuous Deployment) Pipeline
# =============================================================================
# Этот workflow запускается при push в main ветку
# Выполняет деплой на VPS сервер с использованием SSH
# =============================================================================

name: Deploy to VPS

# Триггеры запуска
on:
  push:
    branches:
      - main  # Только при push в main (после merge PR)

  # Возможность запуска вручную из GitHub UI
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Переменные окружения
env:
  NODE_VERSION: '20.x'
  APP_DIR: '/var/www/postcard-bot'  # Директория приложения на сервере

# Конкурентность - предотвращает одновременные деплои
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # JOB 1: Сборка проекта
  # ===========================================================================
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # -----------------------------------------------------------------------
      # Сборка Backend
      # -----------------------------------------------------------------------
      - name: Install backend dependencies
        run: npm ci
        working-directory: ./backend

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: ./backend

      - name: Build backend
        run: npm run build
        working-directory: ./backend

      # -----------------------------------------------------------------------
      # Сборка Frontend с production переменными
      # -----------------------------------------------------------------------
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Build frontend
        run: npm run build
        working-directory: ./frontend
        env:
          # Production переменные окружения для frontend
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_TELEGRAM_BOT_USERNAME: ${{ secrets.VITE_TELEGRAM_BOT_USERNAME }}

      # -----------------------------------------------------------------------
      # Подготовка артефактов для деплоя
      # -----------------------------------------------------------------------
      - name: Create deployment package
        run: |
          # Создаем директорию для деплоя
          mkdir -p deploy-package

          # Копируем backend (dist + необходимые файлы)
          mkdir -p deploy-package/backend
          cp -r backend/dist deploy-package/backend/
          cp backend/package.json deploy-package/backend/
          cp backend/package-lock.json deploy-package/backend/
          cp backend/ecosystem.config.js deploy-package/backend/
          cp -r backend/prisma deploy-package/backend/

          # Копируем frontend build
          mkdir -p deploy-package/frontend
          cp -r frontend/dist deploy-package/frontend/

          # Копируем скрипты деплоя
          cp -r deploy deploy-package/ 2>/dev/null || true

          # Создаем архив
          tar -czvf deploy-package.tar.gz deploy-package

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy-package.tar.gz
          retention-days: 5

  # ===========================================================================
  # JOB 2: Деплой на VPS
  # ===========================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build

    # Environment protection rules (опционально - настраивается в GitHub)
    environment:
      name: production
      url: ${{ secrets.APP_URL }}

    steps:
      # -----------------------------------------------------------------------
      # Шаг 1: Скачивание артефактов сборки
      # -----------------------------------------------------------------------
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deploy-package

      # -----------------------------------------------------------------------
      # Шаг 2: Настройка SSH ключа
      # -----------------------------------------------------------------------
      - name: Setup SSH key
        run: |
          # Создаем директорию .ssh
          mkdir -p ~/.ssh

          # Записываем приватный ключ
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Добавляем сервер в known_hosts (избегаем интерактивного подтверждения)
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        # Настраивает SSH для безопасного подключения к VPS

      # -----------------------------------------------------------------------
      # Шаг 3: Копирование файлов на сервер
      # -----------------------------------------------------------------------
      - name: Copy files to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            deploy-package.tar.gz \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/
        # Копирует архив на сервер через SCP

      # -----------------------------------------------------------------------
      # Шаг 4: Выполнение деплоя на сервере
      # -----------------------------------------------------------------------
      - name: Execute deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'

          set -e  # Остановить при ошибке

          echo "=========================================="
          echo "Starting deployment..."
          echo "=========================================="

          # Переменные
          APP_DIR="/var/www/postcard-bot"
          BACKUP_DIR="/var/www/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Создаем backup текущей версии
          echo "Creating backup..."
          mkdir -p $BACKUP_DIR
          if [ -d "$APP_DIR" ]; then
            tar -czvf $BACKUP_DIR/backup_$TIMESTAMP.tar.gz -C $APP_DIR . 2>/dev/null || true
            # Удаляем старые бекапы (оставляем последние 5)
            ls -t $BACKUP_DIR/backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
          fi

          # Распаковываем новую версию
          echo "Extracting new version..."
          cd /tmp
          rm -rf deploy-package
          tar -xzvf deploy-package.tar.gz

          # Создаем директории если не существуют
          mkdir -p $APP_DIR/backend
          mkdir -p $APP_DIR/frontend
          mkdir -p $APP_DIR/logs

          # Сохраняем .env файлы (они не должны быть в репозитории)
          echo "Preserving environment files..."
          if [ -f "$APP_DIR/backend/.env" ]; then
            cp $APP_DIR/backend/.env /tmp/backend.env.bak
          fi

          # Копируем backend
          echo "Deploying backend..."
          rm -rf $APP_DIR/backend/dist
          cp -r deploy-package/backend/* $APP_DIR/backend/

          # Восстанавливаем .env
          if [ -f "/tmp/backend.env.bak" ]; then
            cp /tmp/backend.env.bak $APP_DIR/backend/.env
          fi

          # Устанавливаем production зависимости
          echo "Installing backend dependencies..."
          cd $APP_DIR/backend
          npm ci --production

          # Генерируем Prisma Client для production
          echo "Generating Prisma client..."
          npx prisma generate

          # Применяем миграции БД
          echo "Running database migrations..."
          npx prisma migrate deploy

          # Копируем frontend (статика)
          echo "Deploying frontend..."
          rm -rf $APP_DIR/frontend/dist
          cp -r /tmp/deploy-package/frontend/dist $APP_DIR/frontend/

          # Устанавливаем правильные права
          echo "Setting permissions..."
          chown -R www-data:www-data $APP_DIR/frontend
          chmod -R 755 $APP_DIR/frontend

          # Перезапускаем backend через PM2
          echo "Restarting backend with PM2..."
          cd $APP_DIR/backend

          # Проверяем, запущен ли уже процесс
          if pm2 describe postcard-bot > /dev/null 2>&1; then
            pm2 reload ecosystem.config.js --env production
          else
            pm2 start ecosystem.config.js --env production
          fi

          # Сохраняем конфигурацию PM2 (для автозапуска)
          pm2 save

          # Перезагружаем Nginx для применения новой конфигурации
          echo "Reloading Nginx..."
          sudo nginx -t && sudo systemctl reload nginx

          # Очистка
          echo "Cleaning up..."
          rm -rf /tmp/deploy-package
          rm -f /tmp/deploy-package.tar.gz
          rm -f /tmp/backend.env.bak

          echo "=========================================="
          echo "Deployment completed successfully!"
          echo "=========================================="

          # Показываем статус
          pm2 status

          DEPLOY_SCRIPT
        # Выполняет полный деплой на сервере

      # -----------------------------------------------------------------------
      # Шаг 5: Проверка здоровья приложения
      # -----------------------------------------------------------------------
      - name: Health check
        run: |
          # Ждем 10 секунд для запуска приложения
          sleep 10

          # Проверяем health endpoint
          HEALTH_URL="${{ secrets.APP_URL }}/api/health"

          echo "Checking health at: $HEALTH_URL"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Health check passed!"
          else
            echo "Warning: Health check returned status $HTTP_STATUS"
            # Не фейлим деплой, но логируем предупреждение
          fi
        continue-on-error: true

      # -----------------------------------------------------------------------
      # Шаг 6: Уведомление об успешном деплое (опционально)
      # -----------------------------------------------------------------------
      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment to production completed successfully!"
          echo "Application URL: ${{ secrets.APP_URL }}"
          # Здесь можно добавить отправку уведомления в Telegram/Slack

      # -----------------------------------------------------------------------
      # Шаг 7: Уведомление о неудачном деплое
      # -----------------------------------------------------------------------
      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Deployment failed! Please check the logs."
          # Здесь можно добавить отправку уведомления об ошибке

  # ===========================================================================
  # JOB 3: Rollback (выполняется только при ручном запуске)
  # ===========================================================================
  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    needs: deploy

    steps:
      - name: Execute rollback
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ROLLBACK_SCRIPT'

          set -e

          echo "Starting rollback..."

          APP_DIR="/var/www/postcard-bot"
          BACKUP_DIR="/var/www/backups"

          # Находим последний бекап
          LATEST_BACKUP=$(ls -t $BACKUP_DIR/backup_*.tar.gz 2>/dev/null | head -1)

          if [ -z "$LATEST_BACKUP" ]; then
            echo "No backup found! Cannot rollback."
            exit 1
          fi

          echo "Rolling back to: $LATEST_BACKUP"

          # Восстанавливаем из бекапа
          cd $APP_DIR
          rm -rf backend/dist frontend/dist
          tar -xzvf $LATEST_BACKUP

          # Перезапускаем PM2
          cd $APP_DIR/backend
          pm2 reload ecosystem.config.js --env production

          # Перезагружаем Nginx
          sudo systemctl reload nginx

          echo "Rollback completed!"

          ROLLBACK_SCRIPT
