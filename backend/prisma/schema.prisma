generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  telegramId      BigInt    @unique
  username        String?
  firstName       String?
  lastName        String?
  languageCode    String    @default("ru")
  isAgeConfirmed  Boolean   @default(false)
  balance         Decimal   @default(0) @db.Decimal(10, 2)
  isBlocked       Boolean   @default(false)
  isAdmin         Boolean   @default(false)
  referralCode    String?   @unique
  referredBy      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastActiveAt    DateTime  @default(now())

  transactions    Transaction[]
  generations     Generation[]
  settings        UserSettings?
  apiUsage        ApiUsage[]
  moderationLogs  ModerationLog[]

  @@index([telegramId])
  @@index([referralCode])
  @@map("users")
}

model UserSettings {
  id                    String   @id @default(uuid())
  userId                String   @unique
  defaultModel          String   @default("flux-1.1-pro")
  defaultAspectRatio    String   @default("1:1")
  notificationsEnabled  Boolean  @default(true)

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  REFUND
  BONUS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model Transaction {
  id              String              @id @default(uuid())
  userId          String
  type            TransactionType
  amount          Decimal             @db.Decimal(10, 2)
  balanceBefore   Decimal             @db.Decimal(10, 2)
  balanceAfter    Decimal             @db.Decimal(10, 2)
  status          TransactionStatus   @default(PENDING)
  paymentMethod   String?
  paymentId       String?             @unique
  description     String?
  metadata        Json?
  createdAt       DateTime            @default(now())
  completedAt     DateTime?
  generationId    String?

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paymentId])
  @@index([status])
  @@map("transactions")
}

model Template {
  id              String       @id @default(uuid())
  nameRu          String
  nameEn          String
  descriptionRu   String?
  descriptionEn   String?
  promptTemplate  String
  category        String
  previewImage    String?
  isActive        Boolean      @default(true)
  sortOrder       Int          @default(0)
  usageCount      Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  generations     Generation[]

  @@index([category])
  @@index([isActive])
  @@map("templates")
}

enum GenerationStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  MODERATED
}

enum GenerationType {
  TEXT_TO_IMAGE
  IMAGE_TO_IMAGE
  INPAINTING
}

model Generation {
  id                    String            @id @default(uuid())
  userId                String

  // Replicate tracking
  replicatePredictionId String?           @unique @map("replicate_prediction_id")

  // Тип генерации
  generationType        GenerationType    @default(TEXT_TO_IMAGE) @map("generation_type")

  // Модель и промпт
  model                 String
  prompt                String
  negativePrompt        String?           @map("negative_prompt")
  templateId            String?           @map("template_id")

  // Параметры генерации
  aspectRatio           String            @map("aspect_ratio")
  width                 Int?
  height                Int?
  guidance              Float?            @default(3.5)
  steps                 Int?              @default(28)
  seed                  Int?
  strength              Float?            @default(0.75)

  // Исходное изображение (для image-to-image и inpainting)
  sourceImageUrl        String?           @map("source_image_url")
  sourceTelegramFileId  String?           @map("source_telegram_file_id")

  // Маска (для inpainting)
  maskImageUrl          String?           @map("mask_image_url")
  maskTelegramFileId    String?           @map("mask_telegram_file_id")

  // Результат
  resultUrl             String?           @map("result_url")
  resultTelegramFileId  String?           @map("result_telegram_file_id")
  generatedImageUrl     String?           @map("generated_image_url")

  // Статус и стоимость
  status                GenerationStatus  @default(PENDING)
  cost                  Decimal           @db.Decimal(10, 4)
  errorMessage          String?           @map("error_message")
  moderationReason      String?           @map("moderation_reason")

  // Legacy поля для совместимости
  externalId            String?           @map("external_id")
  metadata              Json?

  // Timestamps
  createdAt             DateTime          @default(now()) @map("created_at")
  startedAt             DateTime?         @map("started_at")
  completedAt           DateTime?         @map("completed_at")
  processingStartedAt   DateTime?         @map("processing_started_at")
  processingEndedAt     DateTime?         @map("processing_ended_at")

  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  template              Template?         @relation(fields: [templateId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([replicatePredictionId])
  @@map("generations")
}

model AiModel {
  id                  String    @id @default(uuid())
  name                String    @unique
  displayNameRu       String
  displayNameEn       String
  descriptionRu       String?
  descriptionEn       String?
  costPerGeneration   Decimal   @db.Decimal(10, 2)
  isActive            Boolean   @default(true)
  maxWidth            Int       @default(1024)
  maxHeight           Int       @default(1024)
  supportedRatios     Json      @default("[\"1:1\", \"16:9\", \"9:16\", \"4:3\", \"3:4\"]")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("ai_models")
}

model SystemSettings {
  id          String    @id @default(uuid())
  key         String    @unique
  value       Json
  description String?
  updatedAt   DateTime  @updatedAt

  @@map("system_settings")
}

// Отслеживание использования API
model ApiUsage {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  date          DateTime  @db.Date
  model         String
  requestCount  Int       @default(0) @map("request_count")
  successCount  Int       @default(0) @map("success_count")
  failedCount   Int       @default(0) @map("failed_count")
  totalCost     Decimal   @default(0) @db.Decimal(10, 4) @map("total_cost")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, model])
  @@index([date])
  @@map("api_usage")
}

// Логирование модерации
model ModerationLog {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  generationId  String?   @map("generation_id")
  inputType     String    @map("input_type")
  inputContent  String    @map("input_content")
  blocked       Boolean   @default(false)
  reason        String?
  createdAt     DateTime  @default(now()) @map("created_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([blocked])
  @@index([createdAt])
  @@map("moderation_logs")
}
