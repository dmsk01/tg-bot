generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  telegramId      BigInt    @unique
  username        String?
  firstName       String?
  lastName        String?
  languageCode    String    @default("ru")
  isAgeConfirmed  Boolean   @default(false)
  balance         Decimal   @default(0) @db.Decimal(10, 2)
  isBlocked       Boolean   @default(false)
  isAdmin         Boolean   @default(false)
  referralCode    String?   @unique
  referredBy      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastActiveAt    DateTime  @default(now())

  transactions    Transaction[]
  generations     Generation[]
  settings        UserSettings?
  apiUsage        ApiUsage[]
  moderationLogs  ModerationLog[]
  promocodeUsages PromocodeUsage[]

  @@index([telegramId])
  @@index([referralCode])
  @@map("users")
}

model UserSettings {
  id                    String   @id @default(uuid())
  userId                String   @unique
  defaultModel          String   @default("flux-1.1-pro")
  defaultAspectRatio    String   @default("1:1")
  notificationsEnabled  Boolean  @default(true)

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  REFUND
  BONUS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model Transaction {
  id              String              @id @default(uuid())
  userId          String
  type            TransactionType
  amount          Decimal             @db.Decimal(10, 2)
  balanceBefore   Decimal             @db.Decimal(10, 2)
  balanceAfter    Decimal             @db.Decimal(10, 2)
  status          TransactionStatus   @default(PENDING)
  paymentMethod   String?
  paymentId       String?             @unique
  description     String?
  metadata        Json?
  createdAt       DateTime            @default(now())
  completedAt     DateTime?
  generationId    String?

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paymentId])
  @@index([status])
  @@map("transactions")
}

model Template {
  id              String       @id @default(uuid())
  nameRu          String
  nameEn          String
  descriptionRu   String?
  descriptionEn   String?
  promptTemplate  String
  category        String
  previewImage    String?
  isActive        Boolean      @default(true)
  sortOrder       Int          @default(0)
  usageCount      Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  generations     Generation[]

  @@index([category])
  @@index([isActive])
  @@map("templates")
}

enum GenerationStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  MODERATED
}

enum GenerationType {
  TEXT_TO_IMAGE
  IMAGE_TO_IMAGE
  INPAINTING
}

model Generation {
  id                    String            @id @default(uuid())
  userId                String

  // Replicate tracking
  replicatePredictionId String?           @unique @map("replicate_prediction_id")

  // Тип генерации
  generationType        GenerationType    @default(TEXT_TO_IMAGE) @map("generation_type")

  // Модель и промпт
  model                 String
  prompt                String
  negativePrompt        String?           @map("negative_prompt")
  templateId            String?           @map("template_id")

  // Параметры генерации
  aspectRatio           String            @map("aspect_ratio")
  width                 Int?
  height                Int?
  guidance              Float?            @default(3.5)
  steps                 Int?              @default(28)
  seed                  Int?
  strength              Float?            @default(0.75)

  // Исходное изображение (для image-to-image и inpainting)
  sourceImageUrl        String?           @map("source_image_url")
  sourceTelegramFileId  String?           @map("source_telegram_file_id")

  // Маска (для inpainting)
  maskImageUrl          String?           @map("mask_image_url")
  maskTelegramFileId    String?           @map("mask_telegram_file_id")

  // Результат
  resultUrl             String?           @map("result_url")
  resultTelegramFileId  String?           @map("result_telegram_file_id")
  generatedImageUrl     String?           @map("generated_image_url")

  // Статус и стоимость
  status                GenerationStatus  @default(PENDING)
  cost                  Decimal           @db.Decimal(10, 4)
  errorMessage          String?           @map("error_message")
  moderationReason      String?           @map("moderation_reason")

  // Legacy поля для совместимости
  externalId            String?           @map("external_id")
  metadata              Json?

  // Timestamps
  createdAt             DateTime          @default(now()) @map("created_at")
  startedAt             DateTime?         @map("started_at")
  completedAt           DateTime?         @map("completed_at")
  processingStartedAt   DateTime?         @map("processing_started_at")
  processingEndedAt     DateTime?         @map("processing_ended_at")

  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  template              Template?         @relation(fields: [templateId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([replicatePredictionId])
  @@map("generations")
}

model AiModel {
  id                  String    @id @default(uuid())
  name                String    @unique
  displayNameRu       String
  displayNameEn       String
  descriptionRu       String?
  descriptionEn       String?
  costPerGeneration   Decimal   @db.Decimal(10, 2)
  isActive            Boolean   @default(true)
  maxWidth            Int       @default(1024)
  maxHeight           Int       @default(1024)
  supportedRatios     Json      @default("[\"1:1\", \"16:9\", \"9:16\", \"4:3\", \"3:4\"]")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("ai_models")
}

model SystemSettings {
  id          String    @id @default(uuid())
  key         String    @unique
  value       Json
  description String?
  updatedAt   DateTime  @updatedAt

  @@map("system_settings")
}

// Отслеживание использования API
model ApiUsage {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  date          DateTime  @db.Date
  model         String
  requestCount  Int       @default(0) @map("request_count")
  successCount  Int       @default(0) @map("success_count")
  failedCount   Int       @default(0) @map("failed_count")
  totalCost     Decimal   @default(0) @db.Decimal(10, 4) @map("total_cost")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, model])
  @@index([date])
  @@map("api_usage")
}

// Логирование модерации
model ModerationLog {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  generationId  String?   @map("generation_id")
  inputType     String    @map("input_type")
  inputContent  String    @map("input_content")
  blocked       Boolean   @default(false)
  reason        String?
  createdAt     DateTime  @default(now()) @map("created_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([blocked])
  @@index([createdAt])
  @@map("moderation_logs")
}

// ============================================
// ADMIN PANEL MODELS
// ============================================

enum AdminRole {
  SUPER_ADMIN   // Полный доступ
  ADMIN         // Управление пользователями, промокодами
  MODERATOR     // Просмотр, модерация контента
  SUPPORT       // Только просмотр, ответы
}

model AdminUser {
  id            String      @id @default(uuid())
  email         String      @unique
  passwordHash  String      @map("password_hash")
  firstName     String?     @map("first_name")
  lastName      String?     @map("last_name")
  role          AdminRole   @default(MODERATOR)
  isActive      Boolean     @default(true) @map("is_active")
  lastLoginAt   DateTime?   @map("last_login_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  adminLogs     AdminLog[]
  createdPromocodes Promocode[] @relation("PromoCodeCreator")

  @@index([email])
  @@index([isActive])
  @@map("admin_users")
}

enum PromocodeType {
  FIXED_AMOUNT    // Фиксированная сумма ($5)
  PERCENTAGE      // Процент от пополнения (10%)
  BONUS_CREDITS   // Бонусные кредиты на генерации
}

model Promocode {
  id               String          @id @default(uuid())
  code             String          @unique
  type             PromocodeType
  value            Decimal         @db.Decimal(10, 4)

  // Ограничения
  maxUsages        Int?            @map("max_usages")
  maxUsagesPerUser Int?            @map("max_usages_per_user") @default(1)
  minBalance       Decimal?        @map("min_balance") @db.Decimal(10, 2)

  // Период действия
  startsAt         DateTime?       @map("starts_at")
  expiresAt        DateTime?       @map("expires_at")

  // Статус
  isActive         Boolean         @default(true) @map("is_active")

  // Метаданные
  description      String?
  createdById      String?         @map("created_by")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  createdBy        AdminUser?      @relation("PromoCodeCreator", fields: [createdById], references: [id], onDelete: SetNull)
  usages           PromocodeUsage[]

  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
  @@map("promocodes")
}

model PromocodeUsage {
  id            String    @id @default(uuid())
  promocodeId   String    @map("promocode_id")
  userId        String    @map("user_id")
  appliedValue  Decimal   @map("applied_value") @db.Decimal(10, 4)
  usedAt        DateTime  @default(now()) @map("used_at")
  transactionId String?   @map("transaction_id")

  promocode     Promocode @relation(fields: [promocodeId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([promocodeId])
  @@index([userId])
  @@index([usedAt])
  @@map("promocode_usages")
}

model AdminLog {
  id          String    @id @default(uuid())
  adminId     String    @map("admin_id")
  action      String
  entityType  String?   @map("entity_type")
  entityId    String?   @map("entity_id")
  details     Json?
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  admin       AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_logs")
}
