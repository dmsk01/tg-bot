generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  telegramId      BigInt    @unique
  username        String?
  firstName       String?
  lastName        String?
  languageCode    String    @default("ru")
  isAgeConfirmed  Boolean   @default(false)
  balance         Decimal   @default(0) @db.Decimal(10, 2)
  isBlocked       Boolean   @default(false)
  isAdmin         Boolean   @default(false)
  referralCode    String?   @unique
  referredBy      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastActiveAt    DateTime  @default(now())

  transactions    Transaction[]
  generations     Generation[]
  settings        UserSettings?

  @@index([telegramId])
  @@index([referralCode])
  @@map("users")
}

model UserSettings {
  id                    String   @id @default(uuid())
  userId                String   @unique
  defaultModel          String   @default("kandinsky-3.1")
  defaultAspectRatio    String   @default("1:1")
  notificationsEnabled  Boolean  @default(true)

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  REFUND
  BONUS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model Transaction {
  id              String              @id @default(uuid())
  userId          String
  type            TransactionType
  amount          Decimal             @db.Decimal(10, 2)
  balanceBefore   Decimal             @db.Decimal(10, 2)
  balanceAfter    Decimal             @db.Decimal(10, 2)
  status          TransactionStatus   @default(PENDING)
  paymentMethod   String?
  paymentId       String?             @unique
  description     String?
  metadata        Json?
  createdAt       DateTime            @default(now())
  completedAt     DateTime?
  generationId    String?

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paymentId])
  @@index([status])
  @@map("transactions")
}

model Template {
  id              String       @id @default(uuid())
  nameRu          String
  nameEn          String
  descriptionRu   String?
  descriptionEn   String?
  promptTemplate  String
  category        String
  previewImage    String?
  isActive        Boolean      @default(true)
  sortOrder       Int          @default(0)
  usageCount      Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  generations     Generation[]

  @@index([category])
  @@index([isActive])
  @@map("templates")
}

enum GenerationStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

model Generation {
  id                  String            @id @default(uuid())
  userId              String
  model               String
  prompt              String
  negativePrompt      String?
  templateId          String?
  aspectRatio         String
  width               Int
  height              Int
  sourceImageUrl      String?
  generatedImageUrl   String?
  status              GenerationStatus  @default(QUEUED)
  cost                Decimal           @db.Decimal(10, 2)
  errorMessage        String?
  externalId          String?
  metadata            Json?
  processingStartedAt DateTime?
  processingEndedAt   DateTime?
  createdAt           DateTime          @default(now())

  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  template            Template?         @relation(fields: [templateId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("generations")
}

model AiModel {
  id                  String    @id @default(uuid())
  name                String    @unique
  displayNameRu       String
  displayNameEn       String
  descriptionRu       String?
  descriptionEn       String?
  costPerGeneration   Decimal   @db.Decimal(10, 2)
  isActive            Boolean   @default(true)
  maxWidth            Int       @default(1024)
  maxHeight           Int       @default(1024)
  supportedRatios     Json      @default("[\"1:1\", \"16:9\", \"9:16\", \"4:3\", \"3:4\"]")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("ai_models")
}

model SystemSettings {
  id          String    @id @default(uuid())
  key         String    @unique
  value       Json
  description String?
  updatedAt   DateTime  @updatedAt

  @@map("system_settings")
}
